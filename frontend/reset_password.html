<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reset Password - Secure Messaging</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="app">
      <header>
        <h1>Secure Messaging</h1>
        <p>Reset your password</p>
      </header>
      <section class="auth" id="reset-page">
        <div class="card">
          <h2>Enter new password</h2>
          <p class="muted">
            Your reset token is valid for 1 hour. Enter your new password below.
            Password must be at least 8 characters with at least one letter,
            one number, and one special character.
          </p>
          <form id="reset-form">
            <label>Reset token <input type="text" name="token" id="reset-token" required /></label>
            <label>New password <input type="password" name="new_password" id="reset-password" required /></label>
            <small class="muted" id="password-hint">
              Password must be at least 8 characters with at least one letter, one number, and one special character
            </small>
            <button type="submit">Change password</button>
          </form>
          <p class="muted">
            <a href="/">Back to home</a>
          </p>
        </div>
      </section>
      <div id="toast" class="toast hidden"></div>
    </div>
    <script type="module">
      const API_BASE = '/api';
      const toast = document.getElementById('toast');
      const form = document.getElementById('reset-form');
      const tokenInput = document.getElementById('reset-token');
      const passwordInput = document.getElementById('reset-password');

      function showToast(message, isError = false) {
        toast.textContent = message;
        toast.classList.remove('hidden', 'error');
        if (isError) toast.classList.add('error');
        setTimeout(() => toast.classList.add('hidden'), 5000);
      }

      async function api(path, { method = 'GET', body } = {}) {
        const headers = { 'Content-Type': 'application/json' };
        const res = await fetch(`${API_BASE}${path}`, {
          method,
          headers,
          credentials: 'include',
          body: body ? JSON.stringify(body) : undefined,
        });
        if (!res.ok) {
          const detail = await res.json().catch(() => ({}));
          throw new Error(detail.detail || detail.message || 'Request failed');
        }
        return res.json();
      }

      // Password validation regex
      const passwordRegex = {
        minLength: /.{8,}/,
        hasLetter: /[a-zA-Z]/,
        hasNumber: /[0-9]/,
        hasSpecial: /[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/
      };

      function validatePassword(password) {
        if (!passwordRegex.minLength.test(password)) {
          return { valid: false, message: 'Password must be at least 8 characters long' };
        }
        if (!passwordRegex.hasLetter.test(password)) {
          return { valid: false, message: 'Password must contain at least one letter' };
        }
        if (!passwordRegex.hasNumber.test(password)) {
          return { valid: false, message: 'Password must contain at least one number' };
        }
        if (!passwordRegex.hasSpecial.test(password)) {
          return { valid: false, message: 'Password must contain at least one special character (!@#$%^&*()_+-=[]{}|;:,.<>?)' };
        }
        return { valid: true, message: '' };
      }

      // If token provided in query string, prefill it
      const params = new URLSearchParams(window.location.search);
      const token = params.get('token');
      if (token) {
        tokenInput.value = token;
      }

      // Password validation on input
      passwordInput.addEventListener('input', (e) => {
        const validation = validatePassword(e.target.value);
        const hint = document.getElementById('password-hint');
        if (e.target.value.length > 0) {
          if (!validation.valid) {
            hint.textContent = validation.message;
            hint.style.color = '#dc2626';
          } else {
            hint.textContent = 'Password meets requirements âœ“';
            hint.style.color = '#16a34a';
          }
        } else {
          hint.textContent = 'Password must be at least 8 characters with at least one letter, one number, and one special character';
          hint.style.color = '';
        }
      });

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const data = Object.fromEntries(new FormData(form));
        
        // Client-side password validation
        const validation = validatePassword(data.new_password);
        if (!validation.valid) {
          showToast(validation.message, true);
          return;
        }
        
        if (!data.token || !data.new_password) {
          showToast('Token and new password are required', true);
          return;
        }
        try {
          await api('/reset-password', { method: 'POST', body: { token: data.token, new_password: data.new_password } });
          showToast('Password changed successfully. Redirecting to login...');
          setTimeout(() => {
            window.location.href = '/';
          }, 2000);
        } catch (error) {
          showToast(error.message, true);
        }
      });
    </script>
  </body>
</html>
